<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Karaoke Poll</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      body {
        font-family: "Nunito", sans-serif;
        background: #f3f4f6;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 40px;
      }

      @media (max-width: 600px) {
        body {
          align-items: stretch;
          padding: 16px;
        }
      }

      h1 {
        font-size: 2rem;
        margin-bottom: 20px;
        color: #111827;
        text-align: center;
        margin-bottom: 50px;
      }

      .input-container {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        width: 100%;
      }

      input {
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1rem;
        width: 100%;
        transition: all 0.2s ease;
        box-sizing: border-box;
      }

      input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
      }

      button {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
        font-size: 1rem;
        font-weight: 600;
        padding: 12px 18px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: background 0.3s ease, transform 0.2s ease;
        flex: 0 0 auto;
      }

      button:hover {
        background: linear-gradient(135deg, #4f46e5, #4338ca);
        transform: translateY(-2px);
      }

      button:active {
        transform: scale(0.97);
      }

      .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: unset;
        width: 100%;
        padding: 16px 20px;
        margin: 12px 0;
        border-radius: 16px;
        background: #f9fafb;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.25s ease;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: 600;
        color: #111827;
        letter-spacing: 0.3px;
        box-sizing: border-box;
      }

      .list-item:hover {
        background: #e0e7ff;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
        transform: translateY(-3px);
      }

      .list-item:active {
        transform: scale(0.97);
      }

      .list-item-votes {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: #fff;
        font-size: 1rem;
        font-weight: 700;
        padding: 6px 14px;
        border-radius: 22px;
        transition: background 0.25s ease;
      }

      .list-item:hover .list-item-votes {
        background: linear-gradient(135deg, #4f46e5, #4338ca);
      }

      .main-container {
        min-width: 500px;
        max-width: 600px;
        width: 100%;
        background: transparent;
      }

      @media (max-width: 600px) {
        .main-container {
          min-width: unset;
          max-width: unset;
          width: 100%;
        }
      }

      #list-container {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <h1>Predlagaj pesem za karaoke!</h1>

      <div class="input-container">
        <input id="karaoke-name" type="text" placeholder="Vnesi ime pesmi" />
        <button id="add-btn">Dodaj</button>
      </div>

      <div id="list-container"></div>
    </div>

    <script>
      const SUPABASE_URL = "https://ohcclcnjqbizebnbling.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9oY2NsY25qcWJpemVibmJsaW5nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzAzMzcsImV4cCI6MjA3NDQwNjMzN30.GHG-bik_-3I8VbTVIF7PbF_EGCY6JCmG0XmrNV6wJFU";

      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const listContainer = document.getElementById("list-container");
      const addBtn = document.getElementById("add-btn");
      const input = document.getElementById("karaoke-name");

      // unique browser ID
      let userId = localStorage.getItem("karaoke_user_id");
      if (!userId) {
        userId = crypto.randomUUID();
        localStorage.setItem("karaoke_user_id", userId);
      }

      async function getKaraokeInfo() {
        const { data, error } = await supabase
          .from("karaoke")
          .select("*")
          .order("id", { ascending: true });

        if (error) return console.error(error);

        listContainer.innerHTML = "";
        if (!data || data.length === 0) {
          listContainer.innerHTML = '<div style="text-align:center;color:#6b7280;font-size:1.1rem;padding:24px;">Ni predlogov</div>';
          return;
        }
        data.forEach((karaoke) => addToUI(karaoke));
      }

      function addToUI(karaoke) {
        const div = document.createElement("div");
        div.classList.add("list-item");
        div.id = karaoke.id;
        div.innerHTML = `
          ${karaoke.ime}
          <div class="list-item-votes">${karaoke.glasovi}</div>
        `;
        div.addEventListener("click", () => voteForKaraoke(karaoke.id, div));
        listContainer.appendChild(div);
      }

      async function addKaraoke() {
        const name = input.value.trim();
        if (!name) return;

        // Remove 'Ni predlogov' label if present
        if (listContainer.innerHTML.includes('Ni predlogov')) {
          listContainer.innerHTML = "";
        }

        const { data, error } = await supabase
          .from("karaoke")
          .insert([{ ime: name, glasovi: 1, ips: JSON.stringify([userId]) }])
          .select();

        if (error) return console.error(error);

        addToUI(data[0]);
        input.value = "";
      }

      async function voteForKaraoke(id, element) {
        const { data, error } = await supabase
          .from("karaoke")
          .select("glasovi, ips")
          .eq("id", id)
          .single();

        if (error || !data) return console.error(error);

        // Convert ips safely into an array
        let currentIps = [];
        if (Array.isArray(data.ips)) {
          currentIps = data.ips;
        } else if (typeof data.ips === "string" && data.ips.trim() !== "") {
          try {
            currentIps = JSON.parse(data.ips);
          } catch {
            currentIps = [];
          }
        }

        // check if user already voted
        if (currentIps.includes(userId)) {
          alert("Za to možnost si že glasoval!");
          return;
        }

        const newVotes = data.glasovi + 1;
        const updatedIps = [...currentIps, userId];

        const { error: updateError } = await supabase
          .from("karaoke")
          .update({
            glasovi: newVotes,
            ips: JSON.stringify(updatedIps),
          })
          .eq("id", id);

        if (updateError) return console.error(updateError);

        // update UI
        const voteEl = element.querySelector(".list-item-votes");
        voteEl.textContent = newVotes;
        element.style.background = "#dbeafe";
        setTimeout(() => (element.style.background = ""), 200);
      }

      addBtn.addEventListener("click", addKaraoke);
      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") addKaraoke();
      });

      getKaraokeInfo();
    </script>
  </body>
</html>
